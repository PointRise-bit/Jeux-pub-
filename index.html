<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ArcadeX â€” 3 Ø£Ù„Ø¹Ø§Ø¨ (Ø¬Ø§Ù‡Ø²Ø©)</title>
  <style>
    :root{
      --bg0:#050611;
      --bg1:#0b1030;
      --card:rgba(255,255,255,.07);
      --stroke:rgba(255,255,255,.12);
      --text:#eef1ff;
      --muted:#aab2dd;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;

      --c:#38bdf8;
      --p:#8b5cf6;
      --g:#22c55e;
      --y:#fbbf24;
      --rose:#fb7185;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 85% -10%, rgba(139,92,246,.40), transparent 55%),
        radial-gradient(900px 520px at 10% 110%, rgba(34,197,94,.22), transparent 60%),
        radial-gradient(850px 520px at 0% 0%, rgba(56,189,248,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    .wrap{width:min(1180px,100%)}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:48px; height:48px; border-radius:16px;
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(139,92,246,.85), rgba(34,197,94,.85));
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-45%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.16), transparent);
      transform: rotate(25deg);
      animation: shine 3.2s linear infinite;
    }
    @keyframes shine{
      0%{transform: translateX(-45%) rotate(25deg)}
      100%{transform: translateX(45%) rotate(25deg)}
    }
    .brand h1{margin:0; font-size:18px}
    .brand .sub{margin:6px 0 0; color:var(--muted); font-size:12.5px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      user-select:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .grid{grid-template-columns: 440px 1fr;}
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:14px;
    }
    .rowTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin:0 0 10px;
    }
    .rowTitle h2{margin:0; font-size:15px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:#dbe0ff;
      font-size:12px;
      user-select:none;
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-bottom:10px;
    }
    .stat{
      background: rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:10px 12px;
      min-width:0;
    }
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-size:18px; font-weight:900; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tab{
      flex:1; min-width:120px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900;
    }
    .tab:active{transform:scale(.98)}
    .tab.active{
      border-color: rgba(56,189,248,.45);
      background: linear-gradient(135deg, rgba(56,189,248,.20), rgba(139,92,246,.18));
    }
    .tab small{color:var(--muted); font-weight:800}

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:12px 14px;
      border-radius: 14px;
      font-size:14px;
      cursor:pointer;
      transition: transform .06s ease, opacity .2s ease, border-color .2s ease;
      font-weight:900;
    }
    button:active{transform:scale(.98)}
    button.primary{
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(139,92,246,.70));
      border-color: rgba(56,189,248,.45);
      color:#04151c;
    }
    button.green{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.65));
      border-color: rgba(34,197,94,.45);
      color:#052e16;
    }
    button.warn{
      background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(251,191,36,.65));
      border-color: rgba(251,191,36,.45);
      color:#2a1b02;
    }
    button:disabled{opacity:.55; cursor:not-allowed}

    .hint{
      color:var(--muted);
      font-size:13px;
      line-height:1.7;
      margin-top:10px;
    }
    .kbd{
      display:inline-block;
      padding:2px 8px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: #dbe0ff;
      font-size:12px;
      margin:0 2px;
    }

    .frame{
      width:min(720px,100%);
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .frame::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(520px 220px at 30% 0%, rgba(56,189,248,.18), transparent 60%),
                  radial-gradient(520px 240px at 70% 120%, rgba(34,197,94,.14), transparent 60%),
                  radial-gradient(460px 240px at 100% 0%, rgba(139,92,246,.14), transparent 60%);
      pointer-events:none;
    }
    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius: 14px;
      background:#050712;
      touch-action:none;
      position:relative;
      z-index:1;
    }
    .bottomNote{
      margin-top:10px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.7;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>ArcadeX â€” 3 Ø£Ù„Ø¹Ø§Ø¨ Ø¬Ø§Ù‡Ø²Ø©</h1>
        <div class="sub">Ù…Ù„Ù ÙˆØ§Ø­Ø¯ â€¢ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ± â€¢ Ø¨Ø¯ÙˆÙ† Backend</div>
      </div>
    </div>
    <div class="pill" id="modePill">ÙˆØ¶Ø¹: ...</div>
  </header>

  <div class="grid">
    <section class="card">
      <div class="rowTitle">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
        <span class="chip" id="gameChip">ğŸ® Snake</span>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">Ø§Ù„Ù†Ù‚Ø§Ø·</div>
          <div class="v" id="score">0</div>
        </div>
        <div class="stat">
          <div class="k">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©</div>
          <div class="v" id="best">0</div>
        </div>
        <div class="stat">
          <div class="k">Ø§Ù„Ø­Ø§Ù„Ø©</div>
          <div class="v" id="status">Ø¬Ø§Ù‡Ø²</div>
        </div>
      </div>

      <div class="rowTitle" style="margin-top:8px">
        <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
        <span class="chip">âœ… ØªØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†</span>
      </div>

      <div class="tabs">
        <button class="tab active" data-game="snake"><span>Snake</span><small>Ø³Ø­Ø¨/Ø£Ø³Ù‡Ù…</small></button>
        <button class="tab" data-game="runner"><span>Runner</span><small>Ù‚ÙØ²</small></button>
        <button class="tab" data-game="shooter"><span>Shooter</span><small>Ø¥Ø·Ù„Ø§Ù‚</small></button>
      </div>

      <div class="btns">
        <button id="startBtn" class="primary">Ø§Ø¨Ø¯Ø£</button>
        <button id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
        <button id="pauseBtn" class="green">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
        <button id="soundBtn" class="warn">ØµÙˆØª: ØªØ´ØºÙŠÙ„</button>
      </div>

      <div class="hint" id="hint"></div>

      <div class="bottomNote">
        Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø´Ø§Ø´Ø© Ø³ÙˆØ¯Ø§Ø¡ Ù…Ø±Ø©: Ø§Ø¶ØºØ· <b>Ø¥Ø¹Ø§Ø¯Ø©</b> Ø«Ù… <b>Ø§Ø¨Ø¯Ø£</b>.
      </div>
    </section>

    <section class="card">
      <div class="rowTitle">
        <h2>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨</h2>
        <span class="chip">Canvas</span>
      </div>
      <div class="frame">
        <canvas id="cv" width="720" height="720"></canvas>
      </div>
    </section>
  </div>
</div>

<script>
(() => {
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');

  const scoreEl = document.getElementById('score');
  const bestEl = document.getElementById('best');
  const statusEl = document.getElementById('status');
  const hintEl = document.getElementById('hint');
  const chipEl = document.getElementById('gameChip');

  const startBtn = document.getElementById('startBtn');
  const restartBtn = document.getElementById('restartBtn');
  const pauseBtn = document.getElementById('pauseBtn');
  const soundBtn = document.getElementById('soundBtn');

  const isTouch = matchMedia("(pointer: coarse)").matches;
  document.getElementById('modePill').textContent = "ÙˆØ¶Ø¹: " + (isTouch ? "Ù‡Ø§ØªÙ (Ù„Ù…Ø³)" : "ÙƒÙ…Ø¨ÙŠÙˆØªØ± (ÙƒÙŠØ¨ÙˆØ±Ø¯)");

  // ---------- Audio ----------
  let soundOn = true;
  let audioCtx = null;
  function beep(freq=440, dur=0.06, type='sine', gain=0.05){
    if(!soundOn) return;
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = type;
      o.frequency.value = freq;
      g.gain.value = gain;
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + dur);
    }catch(e){}
  }

  // ---------- Helpers ----------
  const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
  function roundRect(x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }
  function bg(){
    const g = ctx.createLinearGradient(0,0,0,cv.height);
    g.addColorStop(0, '#070a14');
    g.addColorStop(1, '#050712');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,cv.width,cv.height);
    ctx.globalAlpha = 0.10;
    for(let i=0;i<80;i++){
      const x = (i*97)%cv.width;
      const y = (i*233)%cv.height;
      ctx.fillStyle = 'white';
      ctx.fillRect(x, y, 2, 2);
    }
    ctx.globalAlpha = 1;
  }
  function setStatus(t){ statusEl.textContent = t; }
  function setScore(v){ scoreEl.textContent = String(v); }
  function setBest(v){ bestEl.textContent = String(v); }

  // ---------- Engine ----------
  let current = null;
  let running = false;
  let paused = false;
  let lastT = 0;

  function start(){
    if(!current) return;
    if(running) return;
    running = true; paused = false;
    pauseBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
    setStatus("ØªØ´ØºÙŠÙ„");
    lastT = performance.now();
    current.onStart?.();
    beep(620, 0.05, 'triangle', 0.06);
  }
  function restart(){
    if(!current) return;
    running = false; paused = false;
    pauseBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
    setStatus("Ø¬Ø§Ù‡Ø²");
    current.reset();
  }
  function togglePause(){
    if(!running) return;
    paused = !paused;
    pauseBtn.textContent = paused ? "Ù…ØªØ§Ø¨Ø¹Ø©" : "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
    setStatus(paused ? "Ù…ØªÙˆÙ‚Ù" : "ØªØ´ØºÙŠÙ„");
    beep(paused ? 300 : 520, 0.05, 'sine', 0.05);
  }
  function gameOver(){
    running = false; paused = false;
    pauseBtn.textContent = "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
    setStatus("Ø§Ù†ØªÙ‡Øª");
    current.onGameOver?.();
  }

  function loop(t){
    requestAnimationFrame(loop);
    if(!current) return;

    if(!running || paused){
      current.draw(true);
      return;
    }

    const dt = Math.min(0.033, (t - lastT) / 1000 || 0);
    lastT = t;
    current.update(dt, gameOver);
    current.draw(false);
  }

  // ---------- Best Storage ----------
  const BEST_KEY = "arcadex_best_v1";
  const bestStore = JSON.parse(localStorage.getItem(BEST_KEY) || "{}");
  function getBest(gameId){ return bestStore[gameId] || 0; }
  function setBestStore(gameId, v){
    bestStore[gameId] = v;
    localStorage.setItem(BEST_KEY, JSON.stringify(bestStore));
  }

  // ======================
  // Game 1: Snake
  // ======================
  function SnakeGame(){
    const id="snake";
    let cell=20, gridN=0, acc=0, speed=10;
    let snake=[], dir={x:1,y:0}, nextDir={x:1,y:0}, apple={x:10,y:10}, grow=0;
    let score=0;

    function resize(){
      const size = Math.min(720, Math.max(420, Math.floor(window.innerWidth*0.86)));
      cv.width = size; cv.height = size;
      gridN = Math.floor(cv.width / cell);
      cv.width = gridN * cell;
      cv.height = gridN * cell;
    }
    function same(a,b){ return a.x===b.x && a.y===b.y; }
    function randCell(){ return {x:(Math.random()*gridN)|0, y:(Math.random()*gridN)|0}; }
    function spawnApple(){
      while(true){
        const p = randCell();
        let bad=false;
        for(const s of snake){ if(same(s,p)){ bad=true; break; } }
        if(!bad){ apple=p; return; }
      }
    }
    function isOpp(a,b){ return a.x===-b.x && a.y===-b.y; }

    function reset(){
      resize();
      score=0; setScore(score); setBest(getBest(id));
      const mid=(gridN/2)|0;
      snake=[{x:mid,y:mid},{x:mid-1,y:mid},{x:mid-2,y:mid}];
      dir={x:1,y:0}; nextDir={x:1,y:0};
      grow=0; acc=0;
      spawnApple();
      draw(true);
    }

    function step(onEnd){
      if(!isOpp(nextDir, dir)) dir = nextDir;
      const h=snake[0];
      const nh={x:h.x+dir.x, y:h.y+dir.y};

      if(nh.x<0||nh.y<0||nh.x>=gridN||nh.y>=gridN) return onEnd();
      for(const s of snake){ if(same(s,nh)) return onEnd(); }

      snake.unshift(nh);
      if(same(nh, apple)){
        score += 10; setScore(score);
        grow += 2;
        beep(740,0.05,'square',0.04);
        spawnApple();
      }
      if(grow>0) grow--; else snake.pop();
    }

    function update(dt, onEnd){
      acc += dt;
      const tick = 1/speed;
      while(acc >= tick){
        acc -= tick;
        step(onEnd);
        if(!running) break;
      }
    }

    function draw(splash){
      bg();

      // grid
      ctx.globalAlpha = 0.18;
      ctx.strokeStyle = 'rgba(255,255,255,.10)';
      for(let i=0;i<=gridN;i++){
        ctx.beginPath(); ctx.moveTo(i*cell+0.5,0); ctx.lineTo(i*cell+0.5,cv.height); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,i*cell+0.5); ctx.lineTo(cv.width,i*cell+0.5); ctx.stroke();
      }
      ctx.globalAlpha = 1;

      // apple
      const ax=apple.x*cell, ay=apple.y*cell;
      ctx.save();
      ctx.shadowColor = 'rgba(34,197,94,.9)';
      ctx.shadowBlur = 22;
      ctx.fillStyle = '#22c55e';
      roundRect(ax+3, ay+3, cell-6, cell-6, Math.max(6, cell*0.28));
      ctx.fill();
      ctx.restore();

      // snake
      for(let i=snake.length-1;i>=0;i--){
        const s=snake[i];
        const x=s.x*cell, y=s.y*cell;
        if(i===0){
          ctx.save();
          ctx.shadowColor='rgba(56,189,248,.85)';
          ctx.shadowBlur=22;
          ctx.fillStyle='#8b5cf6';
          roundRect(x+2, y+2, cell-4, cell-4, Math.max(7, cell*0.32));
          ctx.fill();
          ctx.restore();
        }else{
          const t=i/snake.length;
          ctx.fillStyle = `rgba(139,92,246,${0.28+(1-t)*0.50})`;
          roundRect(x+3, y+3, cell-6, cell-6, Math.max(6, cell*0.26));
          ctx.fill();
        }
      }

      if(splash && !running){
        ctx.fillStyle='rgba(255,255,255,.92)';
        ctx.font='900 28px Arial';
        ctx.textAlign='center';
        ctx.fillText('Snake', cv.width/2, cv.height/2 - 10);
        ctx.fillStyle='rgba(255,255,255,.75)';
        ctx.font='16px Arial';
        ctx.fillText('Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" Ø£Ùˆ Ø§Ø³Ø­Ø¨/Ø£Ø³Ù‡Ù… Ù„Ù„ØªØ­ÙƒÙ…', cv.width/2, cv.height/2 + 18);
        ctx.textAlign='start';
      }
    }

    function onGameOver(){
      const b = getBest(id);
      if(score > b){
        setBestStore(id, score);
        setBest(score);
        beep(880,0.06,'triangle',0.06); beep(990,0.06,'triangle',0.06);
      }else{
        beep(180,0.12,'sawtooth',0.04);
      }
    }

    // input
    function onKey(k){
      const s=k.toLowerCase();
      if(['arrowup','w'].includes(s)) nextDir={x:0,y:-1};
      if(['arrowdown','s'].includes(s)) nextDir={x:0,y:1};
      if(['arrowright','d'].includes(s)) nextDir={x:1,y:0};
      if(['arrowleft','a'].includes(s)) nextDir={x:-1,y:0};
    }
    let p0=null;
    function onPointerDown(e){ if(!running) start(); p0={x:e.clientX,y:e.clientY}; }
    function onPointerMove(e){
      if(!p0) return;
      const dx=e.clientX-p0.x, dy=e.clientY-p0.y;
      const adx=Math.abs(dx), ady=Math.abs(dy);
      if(adx<18 && ady<18) return;
      if(adx>ady) nextDir = dx>0?{x:1,y:0}:{x:-1,y:0};
      else nextDir = dy>0?{x:0,y:1}:{x:0,y:-1};
      p0={x:e.clientX,y:e.clientY};
    }
    function onPointerUp(){ p0=null; }

    return {
      id, chip:"ğŸ® Snake",
      hint:`â€¢ Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ø³Ø­Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡.<br>
            â€¢ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: Ø§Ù„Ø£Ø³Ù‡Ù… <span class="kbd">â†‘</span><span class="kbd">â†“</span><span class="kbd">â†’</span><span class="kbd">â†</span> Ø£Ùˆ <span class="kbd">WASD</span>.`,
      reset, update, draw, onGameOver,
      onKey, onPointerDown, onPointerMove, onPointerUp
    };
  }

  // ======================
  // Game 2: Runner
  // ======================
  function RunnerGame(){
    const id="runner";
    let w=720,h=520;
    let score=0;

    let px=120, py=0, vy=0;
    const groundH=96;
    let groundY=0;
    const grav=2400, jumpV=-900;
    let onGround=true;

    let obs=[], spawnT=0, speed=420;

    function resize(){
      const sizeW = Math.min(720, Math.max(420, Math.floor(window.innerWidth*0.90)));
      w=sizeW; h=Math.floor(sizeW*0.72);
      cv.width=w; cv.height=h;
      groundY=h-groundH;
    }
    function reset(){
      resize();
      score=0; setScore(score); setBest(getBest(id));
      px=120; py=groundY-54; vy=0; onGround=true;
      obs=[]; spawnT=0;
      draw(true);
    }
    function spawn(){
      const hh=36+Math.random()*56, ww=26+Math.random()*22;
      obs.push({x:w+40, y:groundY-hh, w:ww, h:hh});
    }
    function rectHit(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

    function jump(){
      if(!running) start();
      if(paused) return;
      if(onGround){
        vy=jumpV; onGround=false;
        beep(520,0.05,'triangle',0.05);
      }
    }

    function update(dt, onEnd){
      score += Math.floor(dt*100);
      setScore(score);

      speed = 420 + Math.min(280, score/80);

      vy += grav*dt;
      py += vy*dt;
      if(py >= groundY-54){
        py = groundY-54; vy=0; onGround=true;
      }

      spawnT -= dt;
      if(spawnT<=0){
        spawn();
        spawnT = 0.85 + Math.random()*0.55;
      }

      for(const o of obs) o.x -= speed*dt;
      while(obs.length && obs[0].x+obs[0].w < -40) obs.shift();

      const pl = {x:px-18,y:py-18,w:44,h:44};
      for(const o of obs){ if(rectHit(pl,o)) return onEnd(); }
    }

    function glowRect(x,y,w,h){
      ctx.save();
      ctx.shadowColor='rgba(251,113,133,.9)';
      ctx.shadowBlur=18;
      ctx.fillStyle='#fb7185';
      roundRect(x,y,w,h,10);
      ctx.fill();
      ctx.restore();
    }

    function draw(splash){
      // background
      const grad = ctx.createLinearGradient(0,0,0,h);
      grad.addColorStop(0,'#071122');
      grad.addColorStop(1,'#050712');
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,w,h);

      // ground
      ctx.fillStyle='rgba(255,255,255,.06)';
      ctx.fillRect(0, groundY, w, groundH);

      // stripes
      ctx.globalAlpha=.28;
      ctx.fillStyle='rgba(139,92,246,.95)';
      const stripeW=36, t=performance.now()/8;
      for(let i=0;i<w/stripeW+2;i++){
        const x=(i*stripeW - (t%(stripeW*2)));
        ctx.fillRect(x, groundY+34, 18, 3);
      }
      ctx.globalAlpha=1;

      // obstacles
      for(const o of obs) glowRect(o.x,o.y,o.w,o.h);

      // player
      ctx.save();
      ctx.shadowColor='rgba(34,197,94,.9)';
      ctx.shadowBlur=20;
      ctx.fillStyle='#22c55e';
      roundRect(px-18, py-18, 44,44,14);
      ctx.fill();
      ctx.restore();

      if(splash && !running){
        ctx.fillStyle='rgba(255,255,255,.92)';
        ctx.font='900 28px Arial';
        ctx.textAlign='center';
        ctx.fillText('Runner', w/2, h/2 - 12);
        ctx.fillStyle='rgba(255,255,255,.75)';
        ctx.font='16px Arial';
        ctx.fillText('Ø§Ø¶ØºØ·/Ù„Ù…Ø³ Ù„Ù„Ù‚ÙØ² â€” ØªØ¬Ù†Ø¨ Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚', w/2, h/2 + 18);
        ctx.textAlign='start';
      }
    }

    function onGameOver(){
      const b = getBest(id);
      if(score > b){
        setBestStore(id, score);
        setBest(score);
        beep(880,0.06,'triangle',0.06); beep(990,0.06,'triangle',0.06);
      }else{
        beep(160,0.12,'sawtooth',0.04);
      }
    }

    function onKey(k){
      const s=k.toLowerCase();
      if(s===' ' || s==='arrowup' || s==='w') jump();
    }
    function onPointerDown(){ jump(); }
    function onPointerMove(){}
    function onPointerUp(){}

    return {
      id, chip:"ğŸƒ Runner",
      hint:`â€¢ Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ø¶ØºØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ù‚ÙØ².<br>
            â€¢ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: <span class="kbd">Space</span> Ø£Ùˆ <span class="kbd">â†‘</span> Ù„Ù„Ù‚ÙØ².`,
      reset, update, draw, onGameOver,
      onKey, onPointerDown, onPointerMove, onPointerUp
    };
  }

  // ======================
  // Game 3: Shooter
  // ======================
  function ShooterGame(){
    const id="shooter";
    let w=720,h=720;
    let score=0;

    let sx=0, sy=0, vx=0;
    let bullets=[], enemies=[];
    let shootCD=0, spawnT=0, drift=0;

    function resize(){
      const size = Math.min(720, Math.max(420, Math.floor(window.innerWidth*0.86)));
      cv.width=size; cv.height=size;
      w=cv.width; h=cv.height;
      sx=w/2; sy=h-78;
    }
    function reset(){
      resize();
      score=0; setScore(score); setBest(getBest(id));
      bullets=[]; enemies=[];
      shootCD=0; spawnT=0; drift=0; vx=0;
      draw(true);
    }
    function shoot(){
      if(!running) start();
      if(paused) return;
      if(shootCD>0) return;
      bullets.push({x:sx, y:sy-26, vy:-980});
      shootCD=0.14;
      beep(760,0.03,'square',0.035);
    }
    function spawnEnemy(){
      const size = 26 + Math.random()*22;
      enemies.push({x:20+Math.random()*(w-40), y:-40, r:size/2, vy:140+Math.random()*140});
    }

    function update(dt, onEnd){
      sx += vx*dt;
      sx = clamp(sx, 26, w-26);

      shootCD = Math.max(0, shootCD - dt);

      spawnT -= dt;
      if(spawnT<=0){
        spawnEnemy();
        spawnT = 0.45 + Math.random()*0.30;
      }

      for(const b of bullets) b.y += b.vy*dt;
      while(bullets.length && bullets[0].y < -60) bullets.shift();

      drift += dt;
      for(const e of enemies){
        e.y += e.vy*dt;
        e.x += Math.sin(drift*2 + e.y/90)*22*dt;
      }
      while(enemies.length && enemies[0].y > h+80) enemies.shift();

      // bullet-enemy
      for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        for(let j=bullets.length-1;j>=0;j--){
          const b=bullets[j];
          const dx=b.x-e.x, dy=b.y-e.y;
          if(dx*dx+dy*dy < (e.r+6)*(e.r+6)){
            enemies.splice(i,1);
            bullets.splice(j,1);
            score += 15; setScore(score);
            beep(520,0.04,'triangle',0.04);
            break;
          }
        }
      }

      // ship collision
      for(const e of enemies){
        const dx=sx-e.x, dy=sy-e.y;
        if(dx*dx+dy*dy < (e.r+22)*(e.r+22)) return onEnd();
      }
    }

    function draw(splash){
      bg();

      // bullets
      for(const b of bullets){
        ctx.save();
        ctx.shadowColor='rgba(56,189,248,.9)';
        ctx.shadowBlur=16;
        ctx.fillStyle='#38bdf8';
        roundRect(b.x-3, b.y-14, 6, 18, 4);
        ctx.fill();
        ctx.restore();
      }

      // enemies
      for(const e of enemies){
        ctx.save();
        ctx.shadowColor='rgba(251,113,133,.9)';
        ctx.shadowBlur=20;
        ctx.fillStyle='#fb7185';
        ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill();
        ctx.restore();
      }

      // ship
      ctx.save();
      ctx.shadowColor='rgba(34,197,94,.9)';
      ctx.shadowBlur=22;
      ctx.fillStyle='#22c55e';
      roundRect(sx-23, sy-23, 46, 46, 16);
      ctx.fill();
      ctx.restore();

      if(splash && !running){
        ctx.fillStyle='rgba(255,255,255,.92)';
        ctx.font='900 28px Arial';
        ctx.textAlign='center';
        ctx.fillText('Shooter', w/2, h/2 - 12);
        ctx.fillStyle='rgba(255,255,255,.75)';
        ctx.font='16px Arial';
        ctx.fillText('Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±ÙŠÙƒ â€” Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚', w/2, h/2 + 18);
        ctx.textAlign='start';
      }
    }

    function onGameOver(){
      const b = getBest(id);
      if(score > b){
        setBestStore(id, score);
        setBest(score);
        beep(880,0.06,'triangle',0.06); beep(990,0.06,'triangle',0.06);
      }else{
        beep(150,0.12,'sawtooth',0.04);
      }
    }

    function onKey(k){
      const s=k.toLowerCase();
      if(s===' ') shoot();
      if(s==='arrowleft' || s==='a') vx=-520;
      if(s==='arrowright'|| s==='d') vx=520;
    }
    function onKeyUp(k){
      const s=k.toLowerCase();
      if(['arrowleft','a','arrowright','d'].includes(s)) vx=0;
    }

    let dragging=false, lastX=0;
    function onPointerDown(e){ if(!running) start(); dragging=true; lastX=e.clientX; shoot(); }
    function onPointerMove(e){
      if(!dragging) return;
      const dx=e.clientX-lastX; lastX=e.clientX;
      sx += dx*1.35;
      sx = clamp(sx, 26, w-26);
    }
    function onPointerUp(){ dragging=false; }

    return {
      id, chip:"ğŸš€ Shooter",
      hint:`â€¢ Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±ÙŠÙƒ ÙˆØ§Ø¶ØºØ· Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚.<br>
            â€¢ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: <span class="kbd">â†</span><span class="kbd">â†’</span> Ù„Ù„ØªØ­Ø±ÙŠÙƒ Ùˆ <span class="kbd">Space</span> Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚.`,
      reset, update, draw, onGameOver,
      onKey, onKeyUp, onPointerDown, onPointerMove, onPointerUp
    };
  }

  // ---------- Switch ----------
  const games = { snake: SnakeGame(), runner: RunnerGame(), shooter: ShooterGame() };

  function useGame(id){
    running=false; paused=false;
    pauseBtn.textContent="Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
    setStatus("Ø¬Ø§Ù‡Ø²");
    current = games[id];

    document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.game===id));
    chipEl.textContent = current.chip;
    hintEl.innerHTML = current.hint;

    setScore(0);
    setBest(getBest(id));
    current.reset();
  }

  // ---------- Events ----------
  startBtn.onclick = start;
  restartBtn.onclick = restart;
  pauseBtn.onclick = togglePause;
  soundBtn.onclick = ()=>{
    soundOn = !soundOn;
    soundBtn.textContent = soundOn ? "ØµÙˆØª: ØªØ´ØºÙŠÙ„" : "ØµÙˆØª: Ø¥ÙŠÙ‚Ø§Ù";
    beep(soundOn ? 600 : 220, 0.05, 'sine', 0.05);
  };

  window.addEventListener('keydown', (e)=> current?.onKey?.(e.key));
  window.addEventListener('keyup', (e)=> current?.onKeyUp?.(e.key));

  cv.addEventListener('pointerdown', (e)=> current?.onPointerDown?.(e));
  cv.addEventListener('pointermove', (e)=> current?.onPointerMove?.(e));
  cv.addEventListener('pointerup',   (e)=> current?.onPointerUp?.(e));
  cv.addEventListener('pointercancel', (e)=> current?.onPointerUp?.(e));

  window.addEventListener('resize', ()=> current?.reset?.());

  document.querySelectorAll('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=> useGame(btn.dataset.game));
  });

  // ---------- Boot ----------
  useGame('snake');
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
