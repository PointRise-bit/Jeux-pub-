<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>ArcadeX League â€” Ù…Ù†ØµØ© Ø£Ù„Ø¹Ø§Ø¨ Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
  <style>
    :root{
      --bg0:#050611;
      --bg1:#080a1a;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.12);
      --text:#eef1ff;
      --muted:#aab2dd;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;

      --p:#8b5cf6;
      --g:#22c55e;
      --c:#38bdf8;
      --y:#fbbf24;
      --rose:#fb7185;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 650px at 85% -10%, rgba(139,92,246,.40), transparent 55%),
        radial-gradient(900px 520px at 10% 110%, rgba(34,197,94,.24), transparent 60%),
        radial-gradient(850px 520px at 0% 0%, rgba(56,189,248,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
    }
    .wrap{width:min(1200px,100%)}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:48px; height:48px; border-radius:16px;
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(139,92,246,.85), rgba(34,197,94,.85));
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.18), transparent);
      transform: rotate(25deg);
      animation: shine 3.2s linear infinite;
    }
    @keyframes shine{
      0%{transform: translateX(-40%) rotate(25deg)}
      100%{transform: translateX(40%) rotate(25deg)}
    }
    .brand h1{margin:0; font-size:18px; letter-spacing:.2px}
    .brand .sub{margin:6px 0 0; color:var(--muted); font-size:12.5px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 1020px){
      .grid{grid-template-columns: 460px 1fr;}
    }

    .card{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding:14px;
    }
    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
    }
    .sectionTitle h2{margin:0; font-size:15px}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color:#dbe0ff;
      font-size:12px;
      user-select:none;
    }

    .stats{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-bottom:10px;
    }
    .stat{
      background: var(--card2);
      border:1px solid var(--stroke);
      border-radius: 14px;
      padding:10px 12px;
      min-width:0;
    }
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-size:18px; font-weight:900; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .tabs{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .tab{
      flex:1;
      min-width: 128px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      font-weight:900;
    }
    .tab:active{transform:scale(.98)}
    .tab.active{
      border-color: rgba(56,189,248,.45);
      background: linear-gradient(135deg, rgba(56,189,248,.20), rgba(139,92,246,.18));
    }
    .tab small{color:var(--muted); font-weight:700}

    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button, input, select{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:12px 14px;
      border-radius: 14px;
      font-size:14px;
      outline:none;
    }
    input{width:100%}
    button{
      cursor:pointer;
      transition: transform .06s ease, opacity .2s ease, border-color .2s ease;
      font-weight:900;
    }
    button:active{transform:scale(.98)}
    button.primary{
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(139,92,246,.70));
      border-color: rgba(56,189,248,.45);
      color:#04151c;
    }
    button.green{
      background: linear-gradient(135deg, rgba(34,197,94,.95), rgba(34,197,94,.65));
      border-color: rgba(34,197,94,.45);
      color:#052e16;
    }
    button.warn{
      background: linear-gradient(135deg, rgba(251,191,36,.95), rgba(251,191,36,.65));
      border-color: rgba(251,191,36,.45);
      color:#2a1b02;
    }
    button.ghost{
      background: rgba(255,255,255,.05);
    }
    button:disabled{opacity:.55; cursor:not-allowed}

    .hint{
      color:var(--muted);
      font-size:13px;
      line-height:1.7;
      margin-top:10px;
    }
    .kbd{
      display:inline-block;
      padding:2px 8px;
      border-radius: 999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      color: #dbe0ff;
      font-size:12px;
      margin:0 2px;
    }

    .gameWrap{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
    }
    .frame{
      width:min(720px,100%);
      background: rgba(255,255,255,.04);
      border:1px solid var(--stroke);
      border-radius: 18px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .frame::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(520px 220px at 30% 0%, rgba(56,189,248,.18), transparent 60%),
                  radial-gradient(520px 240px at 70% 120%, rgba(34,197,94,.14), transparent 60%),
                  radial-gradient(460px 240px at 100% 0%, rgba(139,92,246,.14), transparent 60%);
      pointer-events:none;
    }
    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius: 14px;
      background:#050712;
      touch-action:none;
      position:relative;
      z-index:1;
    }
    .bottomBar{
      width:min(720px,100%);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.7;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (min-width: 520px){
      .split{grid-template-columns: 1fr 1fr;}
    }
    .panel{
      background: rgba(255,255,255,.05);
      border:1px solid var(--stroke);
      border-radius: 16px;
      padding:12px;
    }
    .panel h3{margin:0 0 8px; font-size:13px}
    .row2{display:flex; gap:10px; align-items:center}
    .row2 > *{flex:1}

    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.04);
    }
    th,td{
      padding:10px 10px;
      text-align:right;
      font-size:13px;
      border-bottom:1px solid rgba(255,255,255,.08);
      color:var(--text);
    }
    th{color:var(--muted); font-weight:900; background: rgba(255,255,255,.04)}
    tr:last-child td{border-bottom:none}
    .tag{
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      font-size:12px;
      font-weight:800;
      white-space:nowrap;
    }
    .tag.ok{border-color: rgba(34,197,94,.35); color:#baf7cf}
    .tag.wait{border-color: rgba(251,191,36,.35); color:#ffe7aa}
    .tag.bad{border-color: rgba(251,113,133,.35); color:#ffc0cc}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px}
    .note{
      margin-top:10px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.7;
    }

    .toast{
      position:fixed;
      left:14px; right:14px; bottom:14px;
      margin:auto;
      width:min(820px, calc(100% - 28px));
      padding:12px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,14,30,.72);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      color: var(--text);
      display:none;
      z-index:1000;
    }
    .toast small{display:block; color:var(--muted); margin-top:4px; line-height:1.6}
    .toast .x{
      float:left;
      cursor:pointer;
      opacity:.8;
      font-weight:900;
      padding:2px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }

    .dangerBox{
      border:1px solid rgba(251,113,133,.22);
      background: rgba(251,113,133,.06);
      padding:10px 12px;
      border-radius: 16px;
      color:#ffd1d9;
      font-size:12.5px;
      line-height:1.7;
      margin-top:10px;
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>ArcadeX League â€” Ù…Ù†ØµØ© Ø£Ù„Ø¹Ø§Ø¨ Ø§Ø­ØªØ±Ø§ÙÙŠØ©</h1>
        <div class="sub">ØµÙØ­Ø© ÙˆØ§Ø­Ø¯Ø© â€¢ 3 Ø£Ù„Ø¹Ø§Ø¨ â€¢ Ø¯ÙˆØ±ÙŠ/ØªØµÙ†ÙŠÙ â€¢ Ù…Ø­ÙØ¸Ø© Ø¯Ø§Ø®Ù„ÙŠØ© + Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨ (ÙŠØ¯ÙˆÙŠÙ‹Ø§)</div>
      </div>
    </div>
    <div class="pill">âš¡ Demo Ø¢Ù…Ù† â€¢ Ø¨Ø¯ÙˆÙ† ØªØ­ÙˆÙŠÙ„Ø§Øª USDT ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</div>
  </header>

  <div class="grid">
    <!-- LEFT: Platform -->
    <section class="card">
      <div class="sectionTitle">
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†ØµØ©</h2>
        <span class="chip" id="gameChip">ğŸ® Snake</span>
      </div>

      <div class="stats">
        <div class="stat">
          <div class="k">Ø§Ù„Ù†Ù‚Ø§Ø· (Session)</div>
          <div class="v" id="score">0</div>
        </div>
        <div class="stat">
          <div class="k">ØªØµÙ†ÙŠÙÙƒ (ELO)</div>
          <div class="v" id="elo">1000</div>
        </div>
        <div class="stat">
          <div class="k">Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ledger)</div>
          <div class="v"><span id="bal">0.00</span> <span class="tag">USDT*</span></div>
        </div>
      </div>

      <div class="sectionTitle" style="margin-top:8px">
        <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
        <span class="chip">â­ Best Ù…Ø­ÙÙˆØ¸</span>
      </div>

      <div class="tabs">
        <button class="tab active" data-game="snake"><span>Snake</span><small>Ø³Ø­Ø¨/Ø£Ø³Ù‡Ù…</small></button>
        <button class="tab" data-game="runner"><span>Runner</span><small>Ù‚ÙØ²</small></button>
        <button class="tab" data-game="shooter"><span>Shooter</span><small>ØªØ­Ø±ÙŠÙƒ/Ø¥Ø·Ù„Ø§Ù‚</small></button>
      </div>

      <div class="btns">
        <button id="startBtn" class="primary">Ø§Ø¨Ø¯Ø£</button>
        <button id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø©</button>
        <button id="pauseBtn" class="green">Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª</button>
        <button id="soundBtn" class="warn">ØµÙˆØª: ØªØ´ØºÙŠÙ„</button>
      </div>

      <div class="split">
        <div class="panel">
          <h3>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙˆØ±ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
          <div class="row2">
            <select id="entrySel">
              <option value="1">Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø±Ø§Ø©: 1.00</option>
              <option value="2">Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø±Ø§Ø©: 2.00</option>
              <option value="5">Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø±Ø§Ø©: 5.00</option>
              <option value="10">Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø±Ø§Ø©: 10.00</option>
            </select>
            <select id="feeSel">
              <option value="0.05">Ø¹Ù…ÙˆÙ„Ø© Ù…Ù†ØµØ©: 5%</option>
              <option value="0.03">Ø¹Ù…ÙˆÙ„Ø© Ù…Ù†ØµØ©: 3%</option>
              <option value="0.02">Ø¹Ù…ÙˆÙ„Ø© Ù…Ù†ØµØ©: 2%</option>
            </select>
          </div>
          <div class="btns" style="margin-top:10px">
            <button class="ghost" id="matchWinBtn">Ø³Ø¬Ù‘Ù„ ÙÙˆØ² âœ…</button>
            <button class="ghost" id="matchLoseBtn">Ø³Ø¬Ù‘Ù„ Ø®Ø³Ø§Ø±Ø© âŒ</button>
          </div>
          <div class="note">
            Ù‡Ø°Ø§ ÙŠØ­Ø§ÙƒÙŠ â€œÙ…Ø¨Ø§Ø±Ø§Ø© Ù…ØµÙ†Ù‘ÙØ©â€: ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« ELO + ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² + Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ø¬Ù„.
          </div>
        </div>

        <div class="panel">
          <h3>Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ledger)</h3>
          <div class="row2">
            <input id="depAmt" type="number" min="0" step="0.01" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ (Ù…Ø«Ù„Ø§Ù‹ 10)"/>
            <button id="depBtn" class="primary">Ø¥ÙŠØ¯Ø§Ø¹</button>
          </div>
          <div class="row2" style="margin-top:10px">
            <input id="wdAmt" type="number" min="0" step="0.01" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ (Ø·Ù„Ø¨)"/>
            <button id="wdBtn" class="warn">Ø·Ù„Ø¨ Ø³Ø­Ø¨</button>
          </div>

          <div class="dangerBox">
            * Ù‡Ø°Ø§ Ù†Ù…ÙˆØ°Ø¬ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¢Ù…Ù†: Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ­ÙˆÙŠÙ„Ø§Øª ÙƒØ±ÙŠØ¨ØªÙˆ Ø­Ù‚ÙŠÙ‚ÙŠØ©. Ø§Ù„Ø³Ø­Ø¨ Ù‡Ù†Ø§ â€œØ·Ù„Ø¨â€ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø¯Ø§Ø®Ù„ Admin.
          </div>
        </div>
      </div>

      <div class="sectionTitle" style="margin-top:12px">
        <h2>ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙˆØ±ÙŠ (Top 5)</h2>
        <span class="chip">ğŸ“ˆ ELO</span>
      </div>

      <table id="rankTable">
        <thead>
          <tr>
            <th>#</th><th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th><th>ELO</th><th>Wins</th><th>Loss</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="sectionTitle" style="margin-top:12px">
        <h2>Admin (Ù…Ø­Ù„ÙŠ)</h2>
        <span class="chip">ğŸ›¡ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø­Ø¨</span>
      </div>

      <table id="wdTable">
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="note">
        ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ ÙÙ‚Ø· (localStorage). Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ Ù…Ù†ØµØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©: ØªØ­ØªØ§Ø¬ Backend + Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª + Ù…Ø²ÙˆØ¯ Ø¯ÙØ¹ Ù…Ø±Ø®Ù‘Øµ.
      </div>
    </section>

    <!-- RIGHT: Game -->
    <section class="card">
      <div class="sectionTitle">
        <h2>Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨</h2>
        <span class="chip" id="modeChip">ÙˆØ¶Ø¹: ...</span>
      </div>

      <div class="gameWrap">
        <div class="frame">
          <canvas id="cv" width="720" height="720"></canvas>
        </div>
        <div class="bottomBar">
          <div id="hint">
            â€¢ Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ø³Ø­Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡.<br>
            â€¢ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: Ø§Ù„Ø£Ø³Ù‡Ù… <span class="kbd">â†‘</span><span class="kbd">â†“</span><span class="kbd">â†’</span><span class="kbd">â†</span> Ø£Ùˆ <span class="kbd">WASD</span>.
          </div>
          <div class="tag">Best: <span id="best">0</span></div>
        </div>
      </div>
    </section>
  </div>
</div>

<div class="toast" id="toast">
  <span class="x" id="toastX">Ã—</span>
  <div id="toastTitle" style="font-weight:900"></div>
  <small id="toastBody"></small>
</div>

<script>
/* =========================
   ArcadeX League (SAFE DEMO)
   - 3 games
   - Ranking (ELO)
   - Internal ledger + withdraw requests (manual review)
   ========================= */

const $ = (id)=>document.getElementById(id);

const cv = $('cv');
const ctx = cv.getContext('2d');

const isTouch = matchMedia("(pointer: coarse)").matches;
$('modeChip').textContent = "ÙˆØ¶Ø¹: " + (isTouch ? "Ù‡Ø§ØªÙ (Ù„Ù…Ø³)" : "ÙƒÙ…Ø¨ÙŠÙˆØªØ± (ÙƒÙŠØ¨ÙˆØ±Ø¯)");

/* ---------- Toast ---------- */
let toastTimer=null;
function toast(title, body=""){
  $('toastTitle').textContent = title;
  $('toastBody').textContent = body;
  $('toast').style.display = 'block';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> $('toast').style.display='none', 4200);
}
$('toastX').onclick = ()=> $('toast').style.display='none';

/* ---------- Audio ---------- */
let soundOn = true;
let audioCtx = null;
function beep(freq=440, dur=0.06, type='sine', gain=0.05){
  if(!soundOn) return;
  try{
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + dur);
  }catch(e){}
}

/* ---------- Storage ---------- */
const KEY = "arcadex_league_v1";
function loadState(){
  const raw = localStorage.getItem(KEY);
  if(raw){
    try{ return JSON.parse(raw); }catch(e){}
  }
  return {
    user: { name:"Ø£Ù†Øª", elo:1000, wins:0, loss:0 },
    ledger: { balance: 0, platformFees: 0, prizePool: 0, tx: [] },
    withdraws: [],
    best: { snake:0, runner:0, shooter:0 },
    leaderboard: [
      {name:"Nova", elo:1120, wins:14, loss:8},
      {name:"Raptor", elo:1088, wins:11, loss:7},
      {name:"Pulse", elo:1055, wins:9, loss:6},
      {name:"Viper", elo:1032, wins:8, loss:7},
    ],
    settings: { entry: 1, fee: 0.05 },
    activeGame: "snake"
  };
}
function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
let state = loadState();

/* ---------- UI binding ---------- */
function fmt(n){ return (Math.round(n*100)/100).toFixed(2); }
function setScore(v){ $('score').textContent = String(v); }
function setElo(v){ $('elo').textContent = String(Math.round(v)); }
function setBal(v){ $('bal').textContent = fmt(v); }
function setBest(v){ $('best').textContent = String(v); }

function renderRank(){
  const rows = [
    ...state.leaderboard,
    {name: state.user.name, elo: state.user.elo, wins: state.user.wins, loss: state.user.loss}
  ].sort((a,b)=>b.elo-a.elo).slice(0,5);

  const tb = $('rankTable').querySelector('tbody');
  tb.innerHTML = rows.map((r,i)=>`
    <tr>
      <td>${i+1}</td>
      <td>${r.name}</td>
      <td>${Math.round(r.elo)}</td>
      <td>${r.wins}</td>
      <td>${r.loss}</td>
    </tr>
  `).join("");
}

function renderWithdraws(){
  const tb = $('wdTable').querySelector('tbody');
  const tag = (st)=>{
    if(st==="PENDING") return `<span class="tag wait">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>`;
    if(st==="APPROVED") return `<span class="tag ok">ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>`;
    return `<span class="tag bad">Ù…Ø±ÙÙˆØ¶</span>`;
  };
  tb.innerHTML = (state.withdraws.slice().reverse()).map((w,idx)=>{
    const i = state.withdraws.length-1-idx;
    return `
      <tr>
        <td class="mono">${new Date(w.ts).toLocaleString()}</td>
        <td>${fmt(w.amount)}</td>
        <td>${tag(w.status)}</td>
        <td>
          ${w.status==="PENDING" ? `
            <button class="ghost" onclick="approveWd(${i})">Ù…ÙˆØ§ÙÙ‚Ø©</button>
            <button class="ghost" onclick="rejectWd(${i})">Ø±ÙØ¶</button>
          ` : `<span class="tag">â€”</span>`}
        </td>
      </tr>
    `;
  }).join("") || `<tr><td colspan="4" style="color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø³Ø­Ø¨</td></tr>`;
}

/* ---------- Ledger ---------- */
function ledgerAdd(type, amount, note){
  state.ledger.tx.unshift({ ts: Date.now(), type, amount, note });
  if(state.ledger.tx.length > 20) state.ledger.tx.length = 20;
}
function deposit(amount){
  if(!(amount>0)) return toast("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­", "Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ù‡Ù†Ø§ ØªØ¬Ø±ÙŠØ¨ÙŠ Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·.");
  state.ledger.balance += amount;
  ledgerAdd("DEPOSIT", amount, "Ø¥ÙŠØ¯Ø§Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ");
  saveState(); syncUI();
  beep(620,0.05,'triangle',0.06);
  toast("ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ (ØªØ¬Ø±ÙŠØ¨ÙŠ)", "ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©.");
}
function requestWithdraw(amount){
  if(!(amount>0)) return toast("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­", "Ø§Ù„Ø³Ø­Ø¨ Ù‡Ù†Ø§ Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙ‚Ø·.");
  if(amount > state.ledger.balance) return toast("Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø§ ÙŠÙƒÙÙŠ", "Ù‚Ù„Ù‘Ù„ Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨ Ø£Ùˆ Ù‚Ù… Ø¨Ø¥ÙŠØ¯Ø§Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ.");
  state.withdraws.push({ ts: Date.now(), amount, status:"PENDING" });
  saveState(); syncUI();
  beep(380,0.05,'sine',0.05);
  toast("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø³Ø­Ø¨", "Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø¬Ø¯ÙˆÙ„ Admin Ù„Ù„Ù…ÙˆØ§ÙÙ‚Ø©/Ø§Ù„Ø±ÙØ¶ (Ù…Ø­Ù„ÙŠ).");
}
window.approveWd = (i)=>{
  const w = state.withdraws[i];
  if(!w || w.status!=="PENDING") return;
  // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯ Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§ (Ù…Ø­Ø§ÙƒØ§Ø©)
  state.ledger.balance -= w.amount;
  w.status="APPROVED";
  ledgerAdd("WITHDRAW_APPROVED", -w.amount, "Ù…ÙˆØ§ÙÙ‚Ø© Ø³Ø­Ø¨ (ØªØ¬Ø±ÙŠØ¨ÙŠ)");
  saveState(); syncUI();
  beep(880,0.06,'triangle',0.06);
  toast("ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©", "ØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ (Ù…Ø­Ø§ÙƒØ§Ø©).");
};
window.rejectWd = (i)=>{
  const w = state.withdraws[i];
  if(!w || w.status!=="PENDING") return;
  w.status="REJECTED";
  saveState(); syncUI();
  beep(180,0.12,'sawtooth',0.04);
  toast("ØªÙ… Ø§Ù„Ø±ÙØ¶", "Ù„Ù… ÙŠØªÙ… Ø®ØµÙ… Ø£ÙŠ Ù…Ø¨Ù„Øº.");
};

/* ---------- League / ELO ---------- */
function eloDelta(win, eloA, eloB){
  // ELO basic
  const K = 28;
  const EA = 1 / (1 + Math.pow(10, (eloB-eloA)/400));
  const SA = win ? 1 : 0;
  return K * (SA - EA);
}

// Match simulation: entry goes to prize pool, fee to platform, result changes ELO
function recordMatch(win){
  const entry = state.settings.entry;
  const fee = state.settings.fee;

  // check balance for entry (safe demo)
  if(state.ledger.balance < entry){
    toast("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ Ù„Ù„Ø¯Ø®ÙˆÙ„", "Ù‚Ù… Ø¨Ø¥ÙŠØ¯Ø§Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø£ÙˆÙ„Ù‹Ø§ Ø«Ù… Ø¬Ø±Ù‘Ø¨ ØªØ³Ø¬ÙŠÙ„ Ù…Ø¨Ø§Ø±Ø§Ø©.");
    return;
  }

  // move funds inside ledger (simulated)
  state.ledger.balance -= entry;
  const feeAmt = entry * fee;
  const poolAmt = entry - feeAmt;

  state.ledger.platformFees += feeAmt;
  state.ledger.prizePool += poolAmt;

  ledgerAdd("MATCH_ENTRY", -entry, `Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø±Ø§Ø© â€” Ø¹Ù…ÙˆÙ„Ø© ${Math.round(fee*100)}%`);

  // ELO update vs a virtual opponent
  const oppElo = 1020 + Math.random()*160; // random opponent strength
  const d = eloDelta(win, state.user.elo, oppElo);
  state.user.elo = Math.max(600, state.user.elo + d);

  if(win){ state.user.wins++; beep(740,0.05,'square',0.04); }
  else{ state.user.loss++; beep(220,0.06,'sine',0.05); }

  // reward logic (SAFE): weekly pool distribution not auto payout.
  // To "motivate", we give small token reward inside ledger on win only (NOT real money transfer).
  if(win){
    const winBonus = Math.max(0.1, entry*0.05); // 5% bonus as internal credit (demo)
    state.ledger.balance += winBonus;
    ledgerAdd("WIN_BONUS", winBonus, "Ù…ÙƒØ§ÙØ£Ø© ÙÙˆØ² (Ø±ØµÙŠØ¯ Ø¯Ø§Ø®Ù„ÙŠ)");
  }

  saveState();
  syncUI();
  toast(win ? "ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ² âœ…" : "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø®Ø³Ø§Ø±Ø© âŒ",
        `ØªÙ… ØªØ­Ø¯ÙŠØ« ELO ÙˆØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² + Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†ØµØ© (Ù…Ø­Ø§ÙƒØ§Ø©).`);
}

/* ---------- Games Engine (3 games) ---------- */
let current = null;
let running = false;
let paused = false;
let raf = null;
let lastT = 0;

function setStatus(t){ $('status').textContent = t; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function roundRect(x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
function bgNeon(){
  const g = ctx.createLinearGradient(0,0,0,cv.height);
  g.addColorStop(0, '#070a14');
  g.addColorStop(1, '#050712');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,cv.width,cv.height);

  ctx.globalAlpha = 0.10;
  for(let i=0;i<70;i++){
    const x = (i*97)%cv.width;
    const y = (i*233)%cv.height;
    ctx.fillStyle = 'white';
    ctx.fillRect(x, y, 2, 2);
  }
  ctx.globalAlpha = 1;
}

function loop(t){
  raf = requestAnimationFrame(loop);
  if(!running || paused || !current) return;

  const dt = Math.min(0.033, (t - lastT) / 1000 || 0);
  lastT = t;

  current.update(dt);
  current.draw();
}

function start(){
  if(!current) return;
  if(running) return;
  running = true;
  paused = false;
  $('pauseBtn').textContent = "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
  setStatus("ØªØ´ØºÙŠÙ„");
  lastT = performance.now();
  current.onStart();
  beep(620, 0.05, 'triangle', 0.06);
}
function restart(){
  if(!current) return;
  running = false;
  paused = false;
  $('pauseBtn').textContent = "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
  current.reset();
  setStatus("Ø¬Ø§Ù‡Ø²");
}
function togglePause(){
  if(!running) return;
  paused = !paused;
  $('pauseBtn').textContent = paused ? "Ù…ØªØ§Ø¨Ø¹Ø©" : "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
  setStatus(paused ? "Ù…ØªÙˆÙ‚Ù" : "ØªØ´ØºÙŠÙ„");
  beep(paused ? 300 : 520, 0.05, 'sine', 0.05);
}
function gameOver(){
  running = false;
  paused = false;
  $('pauseBtn').textContent = "Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª";
  setStatus("Ø§Ù†ØªÙ‡Øª");
  current.onGameOver();
}

/* --- Game: Snake --- */
function SnakeGame(){
  const id="snake";
  let best = state.best[id] || 0;

  let cell=20, gridN=0, acc=0, speed=10;
  let snake=[], dir={x:1,y:0}, nextDir={x:1,y:0}, apple={x:10,y:10}, grow=0;
  let score=0;

  function resize(){
    const size = Math.min(720, Math.max(460, Math.floor(window.innerWidth*0.86)));
    cv.width = size; cv.height = size;
    gridN = Math.floor(cv.width / cell);
    cv.width = gridN * cell;
    cv.height = gridN * cell;
  }
  function randCell(){ return {x:(Math.random()*gridN)|0, y:(Math.random()*gridN)|0}; }
  function same(a,b){ return a.x===b.x && a.y===b.y; }
  function spawnApple(){
    while(true){
      const p = randCell();
      let bad=false;
      for(const s of snake){ if(same(s,p)){ bad=true; break; } }
      if(!bad){ apple=p; return; }
    }
  }
  function isOpp(a,b){ return a.x===-b.x && a.y===-b.y; }

  function reset(){
    resize();
    score=0; setScore(score);
    best = state.best[id] || 0;
    setBest(best);

    const mid=(gridN/2)|0;
    snake=[{x:mid,y:mid},{x:mid-1,y:mid},{x:mid-2,y:mid}];
    dir={x:1,y:0}; nextDir={x:1,y:0};
    grow=0; acc=0;
    spawnApple();
    draw(true);
  }

  function step(){
    if(!isOpp(nextDir, dir)) dir = nextDir;
    const h=snake[0];
    const nh={x:h.x+dir.x, y:h.y+dir.y};
    if(nh.x<0||nh.y<0||nh.x>=gridN||nh.y>=gridN) return gameOver();
    for(const s of snake){ if(same(s,nh)) return gameOver(); }
    snake.unshift(nh);
    if(same(nh, apple)){
      score += 10; setScore(score);
      grow += 2;
      beep(740,0.05,'square',0.04);
      spawnApple();
    }
    if(grow>0) grow--; else snake.pop();
  }

  function update(dt){
    acc += dt;
    const tick = 1/speed;
    while(acc >= tick){
      acc -= tick;
      step();
      if(!running) break;
    }
  }

  function draw(splash=false){
    bgNeon();
    // grid
    ctx.globalAlpha = 0.18;
    ctx.strokeStyle = 'rgba(255,255,255,.10)';
    for(let i=0;i<=gridN;i++){
      ctx.beginPath(); ctx.moveTo(i*cell+0.5,0); ctx.lineTo(i*cell+0.5,cv.height); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(0,i*cell+0.5); ctx.lineTo(cv.width,i*cell+0.5); ctx.stroke();
    }
    ctx.globalAlpha = 1;

    // apple
    const ax=apple.x*cell, ay=apple.y*cell;
    ctx.save();
    ctx.shadowColor = 'rgba(34,197,94,.9)';
    ctx.shadowBlur = 22;
    ctx.fillStyle = '#22c55e';
    roundRect(ax+3, ay+3, cell-6, cell-6, Math.max(6, cell*0.28));
    ctx.fill();
    ctx.restore();

    for(let i=snake.length-1;i>=0;i--){
      const s=snake[i];
      const x=s.x*cell, y=s.y*cell;
      if(i===0){
        ctx.save();
        ctx.shadowColor = 'rgba(56,189,248,.85)';
        ctx.shadowBlur = 22;
        ctx.fillStyle = '#8b5cf6';
        roundRect(x+2, y+2, cell-4, cell-4, Math.max(7, cell*0.32));
        ctx.fill();
        ctx.restore();

        ctx.fillStyle = 'rgba(0,0,0,.35)';
        ctx.beginPath();
        ctx.arc(x+cell*0.65, y+cell*0.40, Math.max(2.0, cell*0.08), 0, Math.PI*2);
        ctx.fill();
      }else{
        const t=i/snake.length;
        ctx.fillStyle = `rgba(139,92,246,${0.32+(1-t)*0.48})`;
        roundRect(x+3, y+3, cell-6, cell-6, Math.max(6, cell*0.26));
        ctx.fill();
      }
    }

    if(splash && !running){
      ctx.fillStyle='rgba(255,255,255,.92)';
      ctx.font='900 28px Arial';
      ctx.textAlign='center';
      ctx.fillText('Snake', cv.width/2, cv.height/2 - 10);
      ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.font='16px Arial';
      ctx.fillText('Ø§Ø¶ØºØ· "Ø§Ø¨Ø¯Ø£" Ø£Ùˆ Ø§Ø³Ø­Ø¨/Ø£Ø³Ù‡Ù… Ù„Ù„ØªØ­ÙƒÙ…', cv.width/2, cv.height/2 + 18);
      ctx.textAlign='start';
    }
  }

  function onStart(){}
  function onGameOver(){
    if(score > best){
      best = score;
      state.best[id] = best;
      saveState();
      setBest(best);
      beep(880,0.06,'triangle',0.06); beep(990,0.06,'triangle',0.06);
      toast("Best Ø¬Ø¯ÙŠØ¯!", "ØªÙ… Ø­ÙØ¸ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ø¨Ø© Snake.");
    }else{
      beep(180,0.12,'sawtooth',0.04);
    }
    ctx.fillStyle='rgba(0,0,0,.55)';
    ctx.fillRect(0,0,cv.width,cv.height);
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.font='900 28px Arial';
    ctx.textAlign='center';
    ctx.fillText('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©', cv.width/2, cv.height/2 - 6);
    ctx.font='16px Arial';
    ctx.fillStyle='rgba(255,255,255,.80)';
    ctx.fillText('Ø§Ø¶ØºØ· "Ø¥Ø¹Ø§Ø¯Ø©" Ø£Ùˆ Ø§Ø¶ØºØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©', cv.width/2, cv.height/2 + 22);
    ctx.textAlign='start';
  }

  function onKey(k){
    const s=k.toLowerCase();
    if(['arrowup','w'].includes(s)) nextDir={x:0,y:-1};
    if(['arrowdown','s'].includes(s)) nextDir={x:0,y:1};
    if(['arrowright','d'].includes(s)) nextDir={x:1,y:0};
    if(['arrowleft','a'].includes(s)) nextDir={x:-1,y:0};
  }
  let p0=null;
  function onPointerDown(e){ if(!running) start(); p0={x:e.clientX,y:e.clientY}; }
  function onPointerMove(e){
    if(!p0) return;
    const dx=e.clientX-p0.x, dy=e.clientY-p0.y;
    const adx=Math.abs(dx), ady=Math.abs(dy);
    if(adx<18 && ady<18) return;
    if(adx>ady) nextDir = dx>0?{x:1,y:0}:{x:-1,y:0};
    else nextDir = dy>0?{x:0,y:1}:{x:0,y:-1};
    p0={x:e.clientX,y:e.clientY};
  }
  function onPointerUp(){ p0=null; }

  return {
    id, title:"Snake", chip:"ğŸ® Snake",
    hint:`â€¢ Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ø³Ø­Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø§ØªØ¬Ø§Ù‡.<br>
          â€¢ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: Ø§Ù„Ø£Ø³Ù‡Ù… <span class="kbd">â†‘</span><span class="kbd">â†“</span><span class="kbd">â†’</span><span class="kbd">â†</span> Ø£Ùˆ <span class="kbd">WASD</span>.<br>
          â€¢ Ø§Ù„Ù‡Ø¯Ù: ÙƒÙÙ„ Ø§Ù„ØªÙØ§Ø­ ÙˆØ§Ø¨ØªØ¹Ø¯ Ø¹Ù† Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù….`,
    reset, update, draw, onStart, onGameOver, onKey, onPointerDown, onPointerMove, onPointerUp,
    getBest(){ return state.best[id]||0; }
  };
}

/* --- Game: Runner --- */
function RunnerGame(){
  const id="runner";
  let best = state.best[id] || 0;

  let w=720, h=520;
  let score=0;

  let px=120, py=0, vy=0;
  const groundH=96;
  let groundY=0;
  const grav=2400;
  const jumpV=-900;
  let onGround=true;

  let obs=[], spawnT=0, speed=420;

  function resize(){
    const sizeW = Math.min(720, Math.max(480, Math.floor(window.innerWidth*0.90)));
    w=sizeW; h=Math.floor(sizeW*0.72);
    cv.width=w; cv.height=h;
    groundY = h - groundH;
  }
  function reset(){
    resize();
    score=0; setScore(score);
    best = state.best[id] || 0;
    setBest(best);

    px=120; py=groundY-54; vy=0; onGround=true;
    obs=[]; spawnT=0;
    draw(true);
  }
  function spawn(){
    const hh=36+Math.random()*56, ww=26+Math.random()*22;
    obs.push({x:w+40, y:groundY-hh, w:ww, h:hh});
  }
  function rectHit(a,b){ return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; }

  function jump(){
    if(!running) start();
    if(paused) return;
    if(onGround){
      vy = jumpV;
      onGround=false;
      beep(520,0.05,'triangle',0.05);
    }
  }

  function update(dt){
    score += Math.floor(dt*100);
    setScore(score);
    speed = 420 + Math.min(280, score/80);

    vy += grav*dt;
    py += vy*dt;
    if(py >= groundY-54){
      py = groundY-54; vy=0; onGround=true;
    }

    spawnT -= dt;
    if(spawnT <= 0){
      spawn();
      spawnT = 0.85 + Math.random()*0.55;
    }

    for(const o of obs) o.x -= speed*dt;
    while(obs.length && obs[0].x+obs[0].w < -40) obs.shift();

    const pl = {x:px-18,y:py-18,w:44,h:44};
    for(const o of obs){ if(rectHit(pl,o)) return gameOver(); }
  }

  function glowFill(x,y,w,h,r,fill,glow){
    ctx.save();
    ctx.shadowColor = glow;
    ctx.shadowBlur = 18;
    ctx.fillStyle = fill;
    roundRect(x,y,w,h,r);
    ctx.fill();
    ctx.restore();
  }

  function draw(splash=false){
    const grad = ctx.createLinearGradient(0,0,0,h);
    grad.addColorStop(0,'#071122');
    grad.addColorStop(1,'#050712');
    ctx.fillStyle=grad;
    ctx.fillRect(0,0,w,h);

    ctx.save();
    ctx.globalAlpha=.25;
    ctx.fillStyle='#38bdf8';
    ctx.fillRect(0, groundY+30, w, 2);
    ctx.restore();

    ctx.fillStyle='rgba(255,255,255,.06)';
    ctx.fillRect(0, groundY, w, groundH);

    ctx.globalAlpha=.28;
    ctx.fillStyle='rgba(139,92,246,.9)';
    const stripeW=36, t=performance.now()/8;
    for(let i=0;i<w/stripeW+2;i++){
      const x=(i*stripeW - (t%(stripeW*2)));
      ctx.fillRect(x, groundY+32, 18, 3);
    }
    ctx.globalAlpha=1;

    for(const o of obs){
      glowFill(o.x,o.y,o.w,o.h,10,'rgba(251,113,133,.95)','rgba(251,113,133,.85)');
    }

    ctx.save();
    ctx.shadowColor='rgba(34,197,94,.9)';
    ctx.shadowBlur=22;
    ctx.fillStyle='#22c55e';
    roundRect(px-18, py-18, 44,44,14);
    ctx.fill();
    ctx.restore();

    ctx.fillStyle='rgba(0,0,0,.35)';
    ctx.beginPath(); ctx.arc(px+10, py-6, 3, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle='rgba(255,255,255,.85)';
    ctx.font='700 14px Arial';
    ctx.fillText('Runner', 12, 22);

    if(splash && !running){
      ctx.fillStyle='rgba(255,255,255,.92)';
      ctx.font='900 28px Arial';
      ctx.textAlign='center';
      ctx.fillText('Runner', w/2, h/2 - 12);
      ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.font='16px Arial';
      ctx.fillText('Ø§Ø¶ØºØ·/Ù„Ù…Ø³ Ù„Ù„Ù‚ÙØ² â€” ØªØ¬Ù†Ø¨ Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚', w/2, h/2 + 18);
      ctx.textAlign='start';
    }
  }

  function onStart(){}
  function onGameOver(){
    if(score > best){
      best = score;
      state.best[id]=best; saveState();
      setBest(best);
      beep(880,0.06,'triangle',0.06); beep(990,0.06,'triangle',0.06);
      toast("Best Ø¬Ø¯ÙŠØ¯!", "ØªÙ… Ø­ÙØ¸ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ø¨Ø© Runner.");
    }else{
      beep(160,0.12,'sawtooth',0.04);
    }
    ctx.fillStyle='rgba(0,0,0,.55)';
    ctx.fillRect(0,0,w,h);
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.font='900 28px Arial';
    ctx.textAlign='center';
    ctx.fillText('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©', w/2, h/2 - 6);
    ctx.font='16px Arial';
    ctx.fillStyle='rgba(255,255,255,.80)';
    ctx.fillText('Ø§Ø¶ØºØ· "Ø¥Ø¹Ø§Ø¯Ø©" Ø£Ùˆ Ø§Ø¶ØºØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©', w/2, h/2 + 22);
    ctx.textAlign='start';
  }

  function onKey(k){
    const s=k.toLowerCase();
    if(s===' ' || s==='arrowup' || s==='w') jump();
  }
  function onPointerDown(){ jump(); }
  function onPointerMove(){}
  function onPointerUp(){}

  return {
    id, title:"Runner", chip:"ğŸƒ Runner",
    hint:`â€¢ Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ø¶ØºØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ù‚ÙØ².<br>
          â€¢ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: <span class="kbd">Space</span> Ø£Ùˆ <span class="kbd">â†‘</span> Ù„Ù„Ù‚ÙØ².<br>
          â€¢ Ø§Ù„Ù‡Ø¯Ù: ØªØ¬Ù†Ø¨ Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚ ÙˆØ§Ø¬Ù…Ø¹ Ø£ÙƒØ¨Ø± Ù†Ù‚Ø§Ø·.`,
    reset, update, draw, onStart, onGameOver, onKey, onPointerDown, onPointerMove, onPointerUp,
    getBest(){ return state.best[id]||0; }
  };
}

/* --- Game: Shooter --- */
function ShooterGame(){
  const id="shooter";
  let best = state.best[id] || 0;

  let w=720, h=720;
  let score=0;
  let sx=0, sy=0, vx=0;
  let bullets=[], enemies=[];
  let shootCD=0, spawnT=0, drift=0;

  function resize(){
    const size = Math.min(720, Math.max(460, Math.floor(window.innerWidth*0.86)));
    cv.width=size; cv.height=size;
    w=cv.width; h=cv.height;
    sx=w/2; sy=h-78;
  }
  function reset(){
    resize();
    score=0; setScore(score);
    best = state.best[id] || 0;
    setBest(best);

    bullets=[]; enemies=[];
    shootCD=0; spawnT=0; drift=0; vx=0;
    draw(true);
  }
  function shoot(){
    if(!running) start();
    if(paused) return;
    if(shootCD>0) return;
    bullets.push({x:sx, y:sy-26, vy:-980});
    shootCD=0.14;
    beep(760,0.03,'square',0.035);
  }
  function spawnEnemy(){
    const size = 26 + Math.random()*22;
    enemies.push({x:20+Math.random()*(w-40), y:-40, r:size/2, vy:140+Math.random()*140});
  }

  function update(dt){
    sx += vx*dt;
    sx = clamp(sx, 26, w-26);

    shootCD = Math.max(0, shootCD - dt);

    spawnT -= dt;
    if(spawnT<=0){
      spawnEnemy();
      spawnT = 0.45 + Math.random()*0.30;
    }

    for(const b of bullets) b.y += b.vy*dt;
    while(bullets.length && bullets[0].y < -60) bullets.shift();

    drift += dt;
    for(const e of enemies){
      e.y += e.vy*dt;
      e.x += Math.sin(drift*2 + e.y/90)*22*dt;
    }
    while(enemies.length && enemies[0].y > h+80) enemies.shift();

    // bullet-enemy
    for(let i=enemies.length-1;i>=0;i--){
      const e=enemies[i];
      for(let j=bullets.length-1;j>=0;j--){
        const b=bullets[j];
        const dx=b.x-e.x, dy=b.y-e.y;
        if(dx*dx+dy*dy < (e.r+6)*(e.r+6)){
          enemies.splice(i,1);
          bullets.splice(j,1);
          score += 15; setScore(score);
          beep(520,0.04,'triangle',0.04);
          break;
        }
      }
    }

    // ship collision
    for(const e of enemies){
      const dx=sx-e.x, dy=sy-e.y;
      if(dx*dx+dy*dy < (e.r+22)*(e.r+22)) return gameOver();
    }
  }

  function draw(splash=false){
    bgNeon();

    ctx.globalAlpha=0.18;
    ctx.fillStyle='white';
    for(let i=0;i<120;i++){
      const x=(i*71 + (performance.now()/12)) % w;
      const y=(i*173) % h;
      ctx.fillRect(x,y,2,2);
    }
    ctx.globalAlpha=1;

    for(const b of bullets){
      ctx.save();
      ctx.shadowColor='rgba(56,189,248,.9)';
      ctx.shadowBlur=18;
      ctx.fillStyle='#38bdf8';
      roundRect(b.x-3, b.y-14, 6, 18, 4);
      ctx.fill();
      ctx.restore();
    }

    for(const e of enemies){
      ctx.save();
      ctx.shadowColor='rgba(251,113,133,.9)';
      ctx.shadowBlur=22;
      ctx.fillStyle='#fb7185';
      ctx.beginPath(); ctx.arc(e.x,e.y,e.r,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }

    ctx.save();
    ctx.shadowColor='rgba(34,197,94,.9)';
    ctx.shadowBlur=24;
    ctx.fillStyle='#22c55e';
    roundRect(sx-23, sy-23, 46, 46, 16);
    ctx.fill();
    ctx.restore();

    ctx.fillStyle='rgba(0,0,0,.30)';
    ctx.beginPath(); ctx.arc(sx+10, sy-8, 6, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle='rgba(255,255,255,.85)';
    ctx.font='700 14px Arial';
    ctx.fillText('Shooter', 12, 22);

    if(splash && !running){
      ctx.fillStyle='rgba(255,255,255,.92)';
      ctx.font='900 28px Arial';
      ctx.textAlign='center';
      ctx.fillText('Space Shooter', w/2, h/2 - 12);
      ctx.fillStyle='rgba(255,255,255,.75)';
      ctx.font='16px Arial';
      ctx.fillText('Ø§Ø³Ø­Ø¨ Ù„Ù„ØªØ­Ø±ÙŠÙƒ â€” Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚', w/2, h/2 + 18);
      ctx.textAlign='start';
    }
  }

  function onStart(){}
  function onGameOver(){
    if(score > best){
      best = score;
      state.best[id]=best; saveState();
      setBest(best);
      beep(880,0.06,'triangle',0.06); beep(990,0.06,'triangle',0.06);
      toast("Best Ø¬Ø¯ÙŠØ¯!", "ØªÙ… Ø­ÙØ¸ Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø© Ù„Ù„Ø¹Ø¨Ø© Shooter.");
    }else{
      beep(150,0.12,'sawtooth',0.04);
    }
    ctx.fillStyle='rgba(0,0,0,.55)';
    ctx.fillRect(0,0,w,h);
    ctx.fillStyle='rgba(255,255,255,.95)';
    ctx.font='900 28px Arial';
    ctx.textAlign='center';
    ctx.fillText('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©', w/2, h/2 - 6);
    ctx.font='16px Arial';
    ctx.fillStyle='rgba(255,255,255,.80)';
    ctx.fillText('Ø§Ø¶ØºØ· "Ø¥Ø¹Ø§Ø¯Ø©" Ø£Ùˆ Ø§Ø¶ØºØ· Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©', w/2, h/2 + 22);
    ctx.textAlign='start';
  }

  function onKey(k){
    const s=k.toLowerCase();
    if(s===' ') shoot();
    if(s==='arrowleft' || s==='a') vx=-520;
    if(s==='arrowright'|| s==='d') vx=520;
  }
  function onKeyUp(k){
    const s=k.toLowerCase();
    if(['arrowleft','a','arrowright','d'].includes(s)) vx=0;
  }
  let dragging=false, lastX=0;
  function onPointerDown(e){ if(!running) start(); dragging=true; lastX=e.clientX; shoot(); }
  function onPointerMove(e){
    if(!dragging) return;
    const dx=e.clientX-lastX; lastX=e.clientX;
    sx += dx*1.35;
    sx = clamp(sx, 26, w-26);
  }
  function onPointerUp(){ dragging=false; }

  return {
    id, title:"Shooter", chip:"ğŸš€ Shooter",
    hint:`â€¢ Ø§Ù„Ù‡Ø§ØªÙ: Ø§Ø³Ø­Ø¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø³ÙÙŠÙ†Ø©ØŒ ÙˆØ§Ø¶ØºØ· Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚.<br>
          â€¢ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±: <span class="kbd">â†</span> <span class="kbd">â†’</span> Ù„Ù„ØªØ­Ø±ÙŠÙƒØŒ Ùˆ <span class="kbd">Space</span> Ù„Ù„Ø¥Ø·Ù„Ø§Ù‚.<br>
          â€¢ Ø§Ù„Ù‡Ø¯Ù: Ø§Ø³Ù‚Ø· Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ ÙˆØªØ¬Ù†Ø¨ Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù….`,
    reset, update, draw, onStart, onGameOver, onKey, onKeyUp, onPointerDown, onPointerMove, onPointerUp,
    getBest(){ return state.best[id]||0; }
  };
}

/* ---------- Switch games ---------- */
const games = { snake: SnakeGame(), runner: RunnerGame(), shooter: ShooterGame() };
function setActiveTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active', t.dataset.game===id));
}
function useGame(id){
  running=false; paused=false; $('pauseBtn').textContent="Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª"; setStatus("Ø¬Ø§Ù‡Ø²");
  state.activeGame = id;
  saveState();

  current = games[id];
  setActiveTab(id);

  $('gameChip').textContent = current.chip;
  $('hint').innerHTML = current.hint;
  setBest(current.getBest());

  setScore(0);
  current.reset();
}

document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=> useGame(btn.dataset.game));
});

/* ---------- Controls ---------- */
$('startBtn').onclick = start;
$('restartBtn').onclick = restart;
$('pauseBtn').onclick = togglePause;

$('soundBtn').onclick = ()=>{
  soundOn = !soundOn;
  $('soundBtn').textContent = soundOn ? "ØµÙˆØª: ØªØ´ØºÙŠÙ„" : "ØµÙˆØª: Ø¥ÙŠÙ‚Ø§Ù";
  beep(soundOn ? 600 : 220, 0.05, 'sine', 0.05);
};

window.addEventListener('keydown', (e)=>{
  if(!running && current && e.key===' ') start();
  current?.onKey?.(e.key);
});
window.addEventListener('keyup', (e)=> current?.onKeyUp?.(e.key));

cv.addEventListener('pointerdown', (e)=> current?.onPointerDown?.(e));
cv.addEventListener('pointermove', (e)=> current?.onPointerMove?.(e));
cv.addEventListener('pointerup', (e)=> current?.onPointerUp?.(e));
cv.addEventListener('pointercancel', (e)=> current?.onPointerUp?.(e));

window.addEventListener('resize', ()=> current?.reset?.());

/* ---------- Platform logic wiring ---------- */
$('entrySel').value = String(state.settings.entry);
$('feeSel').value = String(state.settings.fee);
$('entrySel').onchange = (e)=>{ state.settings.entry = +e.target.value; saveState(); toast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¯Ø®ÙˆÙ„", "Ø³ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©."); };
$('feeSel').onchange = (e)=>{ state.settings.fee = +e.target.value; saveState(); toast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©", "Ø³ÙŠØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©."); };

$('matchWinBtn').onclick = ()=> recordMatch(true);
$('matchLoseBtn').onclick = ()=> recordMatch(false);

$('depBtn').onclick = ()=>{
  const v = parseFloat($('depAmt').value);
  $('depAmt').value="";
  deposit(v);
};
$('wdBtn').onclick = ()=>{
  const v = parseFloat($('wdAmt').value);
  $('wdAmt').value="";
  requestWithdraw(v);
};

/* ---------- UI sync ---------- */
function syncUI(){
  setElo(state.user.elo);
  setBal(state.ledger.balance);
  renderRank();
  renderWithdraws();
}
function setElo(v){ $('elo').textContent = String(Math.round(v)); }

/* ---------- Boot ---------- */
syncUI();
useGame(state.activeGame || "snake");
requestAnimationFrame(loop);
</script>
</body>
</html>
